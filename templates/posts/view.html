{% extends "base.html" %}

{% block title %}{{ post.title }} - Flask Blog{% endblock %}

{% block content %}
<article class="post-view">
    <header class="post-header">
        <h1>{{ post.title }}</h1>
        <div class="post-meta">
            <span class="post-author">By {{ post.author.username }}</span>
            <span class="post-date">{{ post.created_at.strftime('%B %d, %Y') }}</span>
            {% if post.updated_at != post.created_at %}
                <span class="post-updated">Updated: {{ post.updated_at.strftime('%B %d, %Y') }}</span>
            {% endif %}
            <span class="post-views">{{ post.view_count }} views</span>
        </div>
    </header>

    <div class="post-content">
        {{ post.content|nl2br }}
    </div>

    <div class="post-actions">
        <div class="like-buttons">
            <button class="btn btn-like {% if user_like and user_like.like_type == 'like' %}active{% endif %}"
                    data-post-id="{{ post.id }}" data-type="like">
                <span class="like-icon"></span>
                <span class="like-count">{{ post.get_like_count() }}</span>
            </button>
            <button class="btn btn-dislike {% if user_like and user_like.like_type == 'dislike' %}active{% endif %}"
                    data-post-id="{{ post.id }}" data-type="dislike">
                <span class="dislike-icon"></span>
                <span class="dislike-count">{{ post.get_dislike_count() }}</span>
            </button>
        </div>

        {% if session.get('user_id') and post.user_id == session.get('user_id') %}
            <div class="author-actions">
                <a href="{{ url_for('posts.edit', id=post.id) }}" class="btn btn-secondary">Edit</a>
                {% if not post.published %}
                    <form action="{{ url_for('posts.publish', id=post.id) }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-success">Publish</button>
                    </form>
                {% endif %}
                <form action="{{ url_for('posts.delete', id=post.id) }}" method="POST" style="display: inline;"
                      onsubmit="return confirm('Are you sure you want to delete this post?');">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        {% endif %}
    </div>
</article>

<section class="comments-section">
    <h2>Comments ({{ post.get_comment_count() }})</h2>

    {% if session.get('user_id') %}
        <form class="comment-form" data-post-id="{{ post.id }}">
            <div class="form-group">
                <textarea name="content" class="form-control" rows="3" placeholder="Write a comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
    {% else %}
        <p><a href="{{ url_for('auth.login') }}">Login</a> to leave a comment.</p>
    {% endif %}

    <div class="comments-list" id="comments-list">
        {% for comment in comments %}
            <div class="comment" data-comment-id="{{ comment.id }}">
                <div class="comment-header">
                    <span class="comment-author">{{ comment.author.username }}</span>
                    <span class="comment-date">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                </div>
                <div class="comment-content">{{ comment.content|nl2br }}</div>
                {% if session.get('user_id') and comment.user_id == session.get('user_id') %}
                    <button class="btn btn-sm btn-danger delete-comment" data-comment-id="{{ comment.id }}">Delete</button>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/post-interactions.js') }}"></script>
{% endblock %}
